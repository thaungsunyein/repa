<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>REPA - Real Estate Personalized Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .message.assistant {
            display: flex;
            justify-content: flex-start;
        }

        .message-content {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .input-container {
            padding: 20px 30px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s;
            font-family: inherit;
        }

        #messageInput:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #sendButton {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        #sendButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #sendButton:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: flex;
            gap: 8px;
            padding: 15px 20px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .welcome-message h2 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #333;
        }

        .welcome-message p {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .example {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
            text-align: left;
            border: 2px solid #e0e0e0;
        }

        .example strong {
            color: #667eea;
            display: block;
            margin-bottom: 10px;
        }

        .example code {
            display: block;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            margin-top: 10px;
        }

        /* Markdown styling for assistant responses */
        .message.assistant .message-content h1,
        .message.assistant .message-content h2,
        .message.assistant .message-content h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #333;
        }

        .message.assistant .message-content h1:first-child,
        .message.assistant .message-content h2:first-child,
        .message.assistant .message-content h3:first-child {
            margin-top: 0;
        }

        .message.assistant .message-content h1 {
            font-size: 24px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .message.assistant .message-content h2 {
            font-size: 20px;
            color: #667eea;
        }

        .message.assistant .message-content h3 {
            font-size: 16px;
            color: #764ba2;
            font-weight: 600;
        }

        .message.assistant .message-content ul,
        .message.assistant .message-content ol {
            margin-left: 20px;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .message.assistant .message-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .message.assistant .message-content strong {
            color: #667eea;
            font-weight: 600;
        }

        .message.assistant .message-content hr {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 20px 0;
        }

        .message.assistant .message-content img {
            max-width: 100%;
            border-radius: 8px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.assistant .message-content p {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .message.assistant .message-content em {
            color: #666;
            font-style: italic;
        }

        .message.assistant .message-content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .message.assistant .message-content pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message.assistant .message-content pre code {
            background: none;
            padding: 0;
        }

        .message.assistant .message-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 15px;
            margin: 10px 0;
            color: #666;
        }

        .message.assistant .message-content a {
            color: #667eea;
            text-decoration: none;
        }

        .message.assistant .message-content a:hover {
            text-decoration: underline;
        }

        /* Auth Modal Styles */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .auth-modal.active {
            display: flex;
        }

        .auth-modal-content {
            background: white;
            border-radius: 24px;
            padding: 0;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 35px 40px;
            text-align: center;
        }

        .auth-header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .auth-header p {
            font-size: 16px;
            opacity: 0.95;
            margin: 0;
        }

        .auth-header .subtitle {
            font-size: 14px;
            opacity: 0.85;
            margin-top: 5px;
        }

        .auth-body {
            padding: 35px 40px;
        }

        .auth-body h2 {
            margin-bottom: 25px;
            color: #333;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .auth-form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .auth-form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .auth-form input {
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s;
            font-family: inherit;
        }

        .auth-form input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .auth-form input::placeholder {
            color: #999;
        }

        .auth-form button {
            padding: 14px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 5px;
        }

        .auth-form button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-form button:active:not(:disabled) {
            transform: translateY(0);
        }

        .auth-form button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            position: relative;
        }

        .auth-form button:disabled::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            top: 50%;
            left: 50%;
            margin-left: -8px;
            margin-top: -8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .auth-toggle {
            text-align: center;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
            color: #666;
            font-size: 14px;
        }

        .auth-toggle a {
            color: #667eea;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            margin-left: 5px;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: #fee;
            color: #c33;
            font-size: 14px;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid #fcc;
            display: none;
            margin-top: -5px;
        }

        .auth-error.active {
            display: block;
            animation: shake 0.4s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .auth-info {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            color: #555;
            margin-bottom: 20px;
        }

        .auth-info strong {
            color: #667eea;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0 0 20px 20px;
        }

        .user-info span {
            font-size: 14px;
        }

        .user-info button {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .user-info button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .profile-link {
            color: white;
            text-decoration: none;
            font-size: 14px;
            margin-right: 15px;
        }

        .profile-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="auth-modal active" id="authModal">
        <div class="auth-modal-content">
            <div class="auth-header">
                <h1>üè† REPA</h1>
                <p>Real Estate Personalized Assistant</p>
                <p class="subtitle">Your AI-powered apartment finder for Switzerland</p>
            </div>
            <div class="auth-body">
                <h2 id="authTitle">Welcome Back!</h2>
                <div class="auth-info" id="authInfo" style="display: none;">
                    <strong>New to REPA?</strong> Create an account to start finding your perfect apartment match.
                </div>
                <form class="auth-form" id="authForm">
                    <div class="auth-form-group">
                        <label for="authEmail">Email Address</label>
                        <input 
                            type="email" 
                            id="authEmail" 
                            placeholder="your.email@example.com" 
                            required
                            autocomplete="email"
                        >
                    </div>
                    <div class="auth-form-group">
                        <label for="authPassword">Password</label>
                        <input 
                            type="password" 
                            id="authPassword" 
                            placeholder="Enter your password" 
                            required
                            autocomplete="current-password"
                        >
                    </div>
                    <div class="auth-error" id="authError"></div>
                    <button type="submit" id="authSubmit">Login</button>
                </form>
                <div class="auth-toggle">
                    <span id="authToggleText">Don't have an account? </span>
                    <a id="authToggleLink" onclick="toggleAuthMode()">Sign up</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1>üè† REPA</h1>
            <p>Real Estate Personalized Assistant</p>
            <div class="user-info">
                <span>Logged in as: <strong id="userEmail"></strong></span>
                <div>
                    <a href="/profile" class="profile-link">Profile</a>
                    <button onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="welcome-message">
                <h2>Welcome! üëã</h2>
                <p>I'm your AI-powered apartment finder for Switzerland.</p>
                <p><strong>Two ways to use REPA:</strong></p>
                <p>1Ô∏è‚É£ <strong>Save Your Preferences:</strong> Tell me what you're looking for and I'll save it to your profile! Optionally include a listing URL to analyze a specific property.</p>
                <p>2Ô∏è‚É£ <strong>Automatic Email Monitoring:</strong> Configure your email in your Profile to automatically analyze new listings from property websites! Set up filters for sender (e.g., homegate, immoscout24) and subject keywords (e.g., "match", "new listing") to customize which emails REPA processes.</p>
                
                <div class="example">
                    <strong>Example - Save Your Preferences:</strong>
                    <code>I'm visiting Switzerland for ski season and want to hit the slopes! I got my wife and her family coming along. So it will be 3-4 people. We want to be right close to the ski action!

Optional: Add a listing URL to analyze a specific property, e.g., https://www.homegate.ch/rent/4002583790</code>
                </div>
                
                <div class="example" style="margin-top: 20px;">
                    <strong>üí° Pro Tip:</strong> Visit your <a href="/profile" style="color: #667eea; text-decoration: underline;">Profile</a> to set up email monitoring! REPA will automatically check your inbox every 5 minutes for emails matching your configured filters (sender and subject keywords) and analyze them against your saved criteria. You can monitor emails from any property website!
                </div>
            </div>
        </div>
        
        <div class="input-container">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="Describe your needs and paste a listing URL, or set up email monitoring in Profile..."
                autocomplete="off"
            >
            <button id="sendButton">Send</button>
        </div>
    </div>

    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        // Auth state
        let authToken = localStorage.getItem('authToken');
        let isLoginMode = true;

        // DOM elements
        const authModal = document.getElementById('authModal');
        const mainContainer = document.getElementById('mainContainer');
        const authForm = document.getElementById('authForm');
        const authTitle = document.getElementById('authTitle');
        const authToggleText = document.getElementById('authToggleText');
        const authToggleLink = document.getElementById('authToggleLink');
        const authSubmit = document.getElementById('authSubmit');
        const authError = document.getElementById('authError');
        const userEmail = document.getElementById('userEmail');
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        // Check auth on load
        if (authToken) {
            showMainApp();
        } else {
            showAuthModal();
            // Focus email input after modal is shown
            setTimeout(() => {
                document.getElementById('authEmail').focus();
            }, 100);
        }

        function showAuthModal() {
            authModal.classList.add('active');
            mainContainer.style.display = 'none';
            // Reset form and focus
            document.getElementById('authEmail').value = '';
            document.getElementById('authPassword').value = '';
            authError.classList.remove('active');
            authError.textContent = '';
            setTimeout(() => {
                document.getElementById('authEmail').focus();
            }, 100);
        }

        function showMainApp() {
            authModal.classList.remove('active');
            mainContainer.style.display = 'flex';
            // Load user email from token (simple decode, in production use proper JWT decode)
            try {
                const payload = JSON.parse(atob(authToken.split('.')[1]));
                userEmail.textContent = payload.email || 'User';
            } catch (e) {
                userEmail.textContent = 'User';
            }
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const authInfo = document.getElementById('authInfo');
            
            if (isLoginMode) {
                authTitle.textContent = 'Welcome Back!';
                authSubmit.textContent = 'Login';
                authToggleText.textContent = "Don't have an account? ";
                authToggleLink.textContent = 'Sign up';
                if (authInfo) authInfo.style.display = 'none';
                document.getElementById('authEmail').setAttribute('autocomplete', 'email');
                document.getElementById('authPassword').setAttribute('autocomplete', 'current-password');
            } else {
                authTitle.textContent = 'Create Account';
                authSubmit.textContent = 'Sign Up';
                authToggleText.textContent = 'Already have an account? ';
                authToggleLink.textContent = 'Login';
                if (authInfo) authInfo.style.display = 'block';
                document.getElementById('authEmail').setAttribute('autocomplete', 'username');
                document.getElementById('authPassword').setAttribute('autocomplete', 'new-password');
            }
            authError.classList.remove('active');
            authError.textContent = '';
            // Clear form
            document.getElementById('authEmail').value = '';
            document.getElementById('authPassword').value = '';
            document.getElementById('authEmail').focus();
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;

            authSubmit.disabled = true;
            authError.classList.remove('active');
            authError.textContent = '';

            try {
                const endpoint = isLoginMode ? '/auth/login' : '/auth/register';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                    credentials: 'include'  // Include credentials for CORS
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { detail: errorText || `HTTP ${response.status}` };
                    }
                    throw new Error(errorData.detail || `Request failed with status ${response.status}`);
                }

                const data = await response.json();

                if (data.access_token) {
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    // Show success briefly before switching
                    authError.classList.remove('active');
                    authError.textContent = '';
                    showMainApp();
                } else {
                    throw new Error('No access token received');
                }
            } catch (error) {
                console.error('Auth error:', error);
                authError.textContent = error.message || 'Network error. Please try again.';
                authError.classList.add('active');
            } finally {
                authSubmit.disabled = false;
            }
        }

        function logout() {
            authToken = null;
            localStorage.removeItem('authToken');
            showAuthModal();
            // Clear chat
            chatContainer.innerHTML = `
                <div class="welcome-message">
                    <h2>Welcome! üëã</h2>
                    <p>I'm your AI-powered apartment finder for Switzerland.</p>
                    <p><strong>Two ways to use REPA:</strong></p>
                    <p>1Ô∏è‚É£ <strong>Save Your Preferences:</strong> Tell me what you're looking for and I'll save it to your profile! Optionally include a listing URL to analyze a specific property.</p>
                    <p>2Ô∏è‚É£ <strong>Automatic Email Monitoring:</strong> Configure your email in your Profile to automatically analyze new listings from property websites! Set up filters for sender (e.g., homegate, immoscout24) and subject keywords (e.g., "match", "new listing") to customize which emails REPA processes.</p>
                    
                    <div class="example">
                        <strong>Example - Save Your Preferences:</strong>
                        <code>I'm visiting Switzerland for ski season and want to hit the slopes! I got my wife and her family coming along. So it will be 3-4 people. We want to be right close to the ski action!

Optional: Add a listing URL to analyze a specific property, e.g., https://www.homegate.ch/rent/4002583790</code>
                    </div>
                    
                    <div class="example" style="margin-top: 20px;">
                        <strong>üí° Pro Tip:</strong> Visit your <a href="/profile" style="color: #667eea; text-decoration: underline;">Profile</a> to set up email monitoring! REPA will automatically check your inbox every 5 minutes for emails matching your configured filters (sender and subject keywords) and analyze them against your saved criteria.
                    </div>
                </div>
            `;
        }

        authForm.addEventListener('submit', handleAuth);
        
        // Allow Enter key to submit form
        document.getElementById('authPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !authSubmit.disabled) {
                handleAuth(e);
            }
        });

        // Debug: Check if marked loaded
        console.log('Marked.js loaded?', typeof marked);

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (isUser) {
                contentDiv.textContent = content;
            } else {
                // Render markdown for assistant messages
                try {
                    // Strip code fence markers if present (LLM sometimes wraps response in ```)
                    let cleanContent = content.trim();
                    if (cleanContent.startsWith('```')) {
                        // Remove opening code fence (```markdown, ```json, etc.)
                        cleanContent = cleanContent.replace(/^```[a-z]*\n/, '');
                        // Remove closing code fence
                        cleanContent = cleanContent.replace(/\n```$/, '');
                    }
                    
                    if (typeof marked !== 'undefined' && marked.parse) {
                        console.log('Using marked.parse');
                        const html = marked.parse(cleanContent);
                        console.log('Content length:', cleanContent.length);
                        console.log('HTML length:', html.length);
                        console.log('First 200 chars of content:', cleanContent.substring(0, 200));
                        console.log('First 200 chars of HTML:', html.substring(0, 200));
                        contentDiv.innerHTML = html;
                        console.log('innerHTML set, childNodes:', contentDiv.childNodes.length);
                    } else if (typeof marked !== 'undefined') {
                        console.log('Using marked() function');
                        contentDiv.innerHTML = marked(cleanContent);
                    } else {
                        console.error('Marked.js not available, showing plain text');
                        contentDiv.style.whiteSpace = 'pre-wrap';
                        contentDiv.textContent = cleanContent;
                    }
                } catch (e) {
                    console.error('Error rendering markdown:', e);
                    contentDiv.style.whiteSpace = 'pre-wrap';
                    contentDiv.textContent = content;
                }
            }
            
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loading';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content loading';
            contentDiv.innerHTML = '<div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div>';
            
            loadingDiv.appendChild(contentDiv);
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) {
                loading.remove();
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Check authentication
            if (!authToken) {
                addMessage('Please login to continue.', false);
                showAuthModal();
                return;
            }

            // Clear welcome message if present
            const welcome = chatContainer.querySelector('.welcome-message');
            if (welcome) {
                welcome.remove();
            }

            // Add user message
            addMessage(message, true);
            messageInput.value = '';
            
            // Disable input
            sendButton.disabled = true;
            messageInput.disabled = true;
            
            // Show loading
            showLoading();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ message }),
                    credentials: 'include'  // Include credentials for CORS
                });

                if (response.status === 401) {
                    // Token expired or invalid
                    logout();
                    addMessage('Session expired. Please login again.', false);
                    return;
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        errorData = { detail: errorText || `HTTP ${response.status}` };
                    }
                    throw new Error(errorData.detail || `Request failed with status ${response.status}`);
                }

                const data = await response.json();
                
                hideLoading();

                if (data.status === 'success') {
                    addMessage(data.response, false);
                } else {
                    addMessage(`Error: ${data.response || 'Unknown error'}`, false);
                }
            } catch (error) {
                hideLoading();
                console.error('Error sending message:', error);
                addMessage(`Error: ${error.message || 'Failed to send message. Please try again.'}`, false);
            } finally {
                // Re-enable input
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        }

        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Focus input on load
        messageInput.focus();
    </script>
</body>
</html>
